<% layout('layouts/app') %>

<link rel="stylesheet" href="/css/stars.css">
<link rel="stylesheet" href="/css/manualStars.css">

<!-- <a href="/places" class="btn btn-primary mb-5 px-4">Back</a> -->

<h1 class="text-center mb-5">One of the BestPoint, <%= place.title %>!</h1>

<div class="row">

  <!-- Start of place card -->

  <div class="col-12 col-lg-8">
    <div class="card mb-5 <%= (currentUser && place.author && place.author.equals(currentUser._id)) ? '' : 'text-bg-light' %>">
      
      <% if (place.images.length > 0) { %>
        <div id="carouselExampleAutoplaying" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-indicators">

            <% if(place.images.length > 1 ) { place.images.forEach((image, index) => { %>
              <button type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide-to="<%= index %>" class="<%= index === 0 ? 'active' : '' %>" aria-current="<%= index === 0 ? 'true' : 'false' %>" aria-label="Slide <%= index + 1 %>"></button>
            <% })} %>

          </div>
          <div class="carousel-inner">

            <% place.images.forEach((image, index) => { %>
              <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                <img src="/images/places/<%= image.filename %>" class="card-img-top w-100" alt="<%= image.title %>">
                <figcaption class="carousel-caption d-none d-md-block">
                  Photo of <%= place.title %> (<%= index + 1 %>)
                </figcaption>
              </div>
            <% }) %>
            
          </div>
    
          <% if(place.images.length > 1 ) { %>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleAutoplaying" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          <% } %>
        
        </div>

      <% } else { %>
        <img src="/images/places/placeholder.jpg" class="card-img-top figure-image w-100" alt="No image available for <%= place.title %>">
        <figcaption class="figure-caption me-5 text-end d-none d-md-block">
          No image available for <%= place.title %>
        </figcaption>
      <% } %>

      <div class="card-body">
        <h3 class="card-title fs-1"><%= place.title %></h3>
        <p class="card-text"></p>
        <ul class="list-group list-group-flush">
          <li class="list-group-item">
            Location: 
            <a href="https://www.google.com/maps/search/<%= place.title %>, <%= place.location %>" target="__blank" rel="noopener" class="text-decoration-none">
              <%= place.location %>
            </a>
          </li>
          <li class="list-group-item">Price: <span class="text-muted">Rp <%= place.price %></span></li>
          <li class="list-group-item d-flex align-items-center gap-1">
            Rating:
            <span class="d-flex align-items-center gap-2">
              <span class="fs-5 fw-bold">
                <%= place.rating %>
              </span>
              <div class="d-flex flex-column justify-content-center align-items-start">
                <span id="placeRating" class="stars starability-result" data-rating="<%= place.rating %>"></span>
                <small id="placeRatingAlt" class="text-muted text-center"></small>
              </div>
            </span>
          </li>
        </ul>
        <div class="card-text my-4">
          <hr/>
          <p style="white-space: pre-wrap; text-align: justify;"><%= place.description %></p>
          <hr/>
        </div>
        <ul class="list-group list-group-flush">
          <li class="list-group-item">
            Author: 
            <% if (place.author === null) { %>
              <small class="text-muted">
                [Deleted User]
              </small>
              <% } else { %>
                <a href="/account/<%= place.author._id %>" class="text-decoration-none font-primary">
                  @<%= place.author.username %>
                </a>
            <% } %>
          </li>
          <li class="list-group-item">
            Created at: 
            <%= new Date(place.createdAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) %>
          </li>
          <li class="list-group-item">
            Updated at: 
            <%= new Date(place.updatedAt).toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' }) %>
          </li>
        </ul>
      </div>
    
      <% if(currentUser && place.author && place.author.equals(currentUser._id)) { %>
      <div class="card-body d-flex gap-2">
        <a href="/places/<%= place.title %>/edit" class="btn card-link btn-outline-warning w-25 d-flex gap-2 align-items-center justify-content-center">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325"/>
          </svg>
          Edit
        </a>
        <button type="button" class="btn btn-outline-danger w-25 d-flex gap-2 align-items-center justify-content-center" data-bs-toggle="modal" data-bs-target="#placeDeleteConfirmationModal">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
          </svg>
          Delete
        </button>

        <!-- Modal -->
        <div class="modal fade" id="placeDeleteConfirmationModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="staticBackdropLabel">Delete Confirmation</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Are you sure you want to delete this place? This action cannot be undone.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary w-25" data-bs-dismiss="modal">Cancel</button>
                <form action="/places/<%= place.title %>?_method=DELETE" method="POST" class="w-25">
                  <button type="submit" class="btn btn-danger w-100 d-flex gap-2 align-items-center justify-content-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                      <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                    </svg>
                    Delete
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

      </div>
      <% } %>
   
    </div>
  </div>

  <!-- End of place card -->

  <!-- Start of reviews section -->

  <div class="col-10 mx-auto col-lg-4">
  
    <h2 class="text-center">Reviews</h2>
    
    <% if(currentUser) { %>
      <div class="card my-4 text-bg-light">
        <div class="card-body">
          <h3>Leave a review</h3>
          <form action="/places/<%= place.title %>/reviews" method="POST" class="validated-form" novalidate>
            <div class="mb-3 d-flex gap-2 align-items-center">
              <label for="rating">Rating: </label>
              <fieldset class="starability-basic">
                <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]" value="1" checked aria-label="No rating." />
                <input type="radio" id="first-rate1" name="review[rating]" value="1" />
                <label for="first-rate1" title="Terrible">1 star</label>
                <input type="radio" id="first-rate2" name="review[rating]" value="2" />
                <label for="first-rate2" title="Not good">2 stars</label>
                <input type="radio" id="first-rate3" name="review[rating]" value="3" />
                <label for="first-rate3" title="Average">3 stars</label>
                <input type="radio" id="first-rate4" name="review[rating]" value="4" />
                <label for="first-rate4" title="Very good">4 stars</label>
                <input type="radio" id="first-rate5" name="review[rating]" value="5" />
                <label for="first-rate5" title="Amazing">5 stars</label>
              </fieldset>
            </div>
            <div class="mb-3">
              <label for="review">Review:</label>
              <textarea class="form-control" id="body" name="review[body]" cols="30" rows="3" required></textarea>
              <div class="valid-feedback">Looks good!</div>
              <div class="invalid-feedback">Please fill out the review!</div>
            </div>
            <div class="d-flex justify-content-end">
              <button type="submit" class="btn btn-success w-50 d-flex gap-2 align-items-center justify-content-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-send" viewBox="0 0 16 16">
                  <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576zm6.787-8.201L1.591 6.602l4.339 2.76z"/>
                </svg>
                Submit
              </button>
            </div>
          </form>
        </div>
      </div>
    <% } else { %>
      <p class="mb-3">
        Cannot leave a reviewðŸ¥º? Don't worry! You can leave a review after you <a href="/login">login</a> or <a href="/register">register</a> an account.
      </p>
    <% } %>

    <hr/>

    <% if (place.reviews.length === 0) { %>
      <div class="mt-5 text-center fw-bold">
        No reviews?ðŸ¥º
      </div>
    <% } else { %>
      <div class="d-flex flex-row justify-content-center align-items-center gap-2 mb-3">
        <div class="d-flex flex-column justify-content-center align-items-center">
          <div class="text-muted">Sorting by order:</div>
          <div class="btn-group btn-group-sm" role="group" aria-label="Order sort group">
            <input type="radio" class="btn-check" name="order" id="orderDesc" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="orderDesc">Newest</label>
        
            <input type="radio" class="btn-check" name="order" id="orderAsc" autocomplete="off">
            <label class="btn btn-outline-primary" for="orderAsc">Oldest</label>
          </div>
        </div>
        <div class="d-flex flex-column justify-content-center align-items-center">
          <div class="text-muted">Sorting by rating:</div>
          <div class="btn-group btn-group-sm" role="group" aria-label="Rating sort button group">
            <input type="radio" class="btn-check" name="rating" id="ratingAsc" autocomplete="off">
            <label class="btn btn-outline-primary" for="ratingAsc">Highest</label>
        
            <input type="radio" class="btn-check" name="rating" id="ratingNone" autocomplete="off" checked>
            <label class="btn btn-outline-primary" for="ratingNone">None</label>
    
            <input type="radio" class="btn-check" name="rating" id="ratingDesc" autocomplete="off">
            <label class="btn btn-outline-primary" for="ratingDesc">Lowest</label>
          </div>
        </div>
      </div>
    
      <div id="reviewsContainer">
        <% for(const review of place.reviews) { %>
          <div class="mt-4" data-timestamp="<%= +new Date(review.createdAt) %>">
            <h5 class="d-flex align-items-center gap-2 fs-6">
              <div>
                <% if (review.author === null) { %>
                  <img class="custom-profil custom-object border rounded-circle" src="/images/profiles/placeholder.jpg" alt="Profile Picture of Deleted User">             
                  <% } else { %>
                  <img class="custom-profil custom-object border rounded-circle" src="<%= (!review.author.profil.url) ? '/images/profiles/placeholder.jpg' : review.author.profil.url %>" alt="Profile Picture of <%= review.author.username %>">             
                <% } %>
              </div>
              <div class="d-flex flex-row align-items-center justify-content-between w-100">

                <span class="d-flex flex-column">
                  <span class="d-flex flex-row align-items-center gap-1">
                    <% if (review.author === null) { %>
                      <small>
                        [Deleted User]
                      </small>
                      <% } else { %>
                        <a href="/account/<%= review.author._id %>" class="text-decoration-none font-primary">@<%= review.author.username %></a>
                        <small class="badge rounded-pill text-bg-primary <%= review.author.equals(place.author) ? 'd-block' : 'd-none' %>">Author</small>
                    <% } %>
                  </span>
                  <small class="text-muted"><%= new Date(review.createdAt).toLocaleString( 'en-US', { minute:'2-digit', hour:'2-digit', day: '2-digit', month: 'long', year: 'numeric' }) %></small>
                </span>
          
                <span>
                  <% if(currentUser && review.author && review.author.equals(currentUser._id)) { %>

                    <button 
                      type="button" 
                      data-bs-toggle="modal" 
                      data-bs-target="#reviewDeleteConfirmationModal<%= review._id %>" 
                    class="btn btn-outline-danger btn-sm d-flex align-items-center justify-content-center"
                    >
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                        <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                        <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                      </svg>
                    </button>
    
                    <!-- Modal -->
                    <div 
                      class="modal fade" 
                      id="reviewDeleteConfirmationModal<%= review._id %>" 
                      data-bs-backdrop="static" 
                      data-bs-keyboard="false" 
                      tabindex="-1" 
                      aria-labelledby="staticBackdropLabel<%= review._id %>" 
                      aria-hidden="true"
                    >
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h1 class="modal-title fs-5" id="staticBackdropLabel<%= review._id %>">
                              Delete Confirmation
                            </h1>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                          </div>
                          <div class="modal-body">
                            Are you sure you want to delete this review? This action cannot be undone.
                          </div>
                            <div class="modal-footer">
                            <button type="button" class="btn btn-secondary w-25" data-bs-dismiss="modal">Cancel</button>
                            <form action="/places/<%= place.title %>/reviews/<%= review._id %>?_method=DELETE" method="POST" class="w-25">
                              <button type="submit" class="btn btn-danger w-100 d-flex gap-2 align-items-center justify-content-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                                  <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z"/>
                                  <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z"/>
                                </svg>
                                Delete
                              </button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
    
                  <% } %>
                </span>
          
              </div>
            </h5>
    
              <div class="card mb-3 <%= (currentUser && review.author && review.author.equals(currentUser._id)) ? '' : 'text-bg-light' %>">
                <div class="card-body">
                  <div class="d-flex align-items-center gap-1 mb-3">
                    <span class="text-muted">Rated: </span>
                    <span class="stars starability-result" data-rating="<%= review.rating %>"></span>
                  </div>
                  <p class="card-text"><%= review.body %></p>
                </div>
              </div>
          </div>
  
        <% } %>
      <% } %>
    </div>
    
  </div>

  <!-- End of reviews section -->

</div>

<style>
  .stars {
    display: inline-block;
    transform: scale(0.6);
    transform-origin: left;
  }
  #placeRating {
    transform: scale(0.75);
  }

  .custom-object {
    height: 45px;
    width: 45px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const url = new URL(window.location.href);

    // Sorting order
    document.getElementById('orderDesc').addEventListener('change', () => {
      url.searchParams.set('order', 'desc'); // newest
      window.location.href = url.toString();
    });

    document.getElementById('orderAsc').addEventListener('change', () => {
      url.searchParams.set('order', 'asc'); // oldest
      window.location.href = url.toString();
    });

    // Sorting rating
    document.getElementById('ratingAsc').addEventListener('change', () => {
      url.searchParams.set('rating', 'desc'); // highest
      window.location.href = url.toString();
    });

    document.getElementById('ratingNone').addEventListener('change', () => {
      url.searchParams.delete('rating'); // none
      window.location.href = url.toString();
    });

    document.getElementById('ratingDesc').addEventListener('change', () => {
      url.searchParams.set('rating', 'asc'); // lowest
      window.location.href = url.toString();
    });

    // Atur default radio terpilih dari query param saat reload
    const orderParam = url.searchParams.get('order');
    const ratingParam = url.searchParams.get('rating');

    if (orderParam === 'asc') {
      document.getElementById('orderAsc').checked = true;
    } else {
      document.getElementById('orderDesc').checked = true;
    }

    if (ratingParam === 'desc') {
      document.getElementById('ratingAsc').checked = true;
    } else if (ratingParam === 'asc') {
      document.getElementById('ratingDesc').checked = true;
    } else {
      document.getElementById('ratingNone').checked = true;
    }
  });
</script>


<script>
  const ratingEl = document.getElementById('placeRating');
  const ratingAltEl = document.getElementById('placeRatingAlt');

  if (ratingEl && ratingAltEl) {
    const rating = parseFloat(ratingEl.getAttribute('data-rating')) || 0;

    let overview = '';
    if (rating >= 5) {
      overview = 'True BestPoint!';
    } else if (rating >= 4.5) {
      overview = 'What a Great Place';
    } else if (rating >= 4.0) {
      overview = 'I like this Place';
    } else if (rating >= 3.5) {
      overview = 'NiceðŸ‘';
    } else if (rating >= 3.0) {
      overview = 'Not bad';
    } else if (rating >= 2.5) {
      overview = 'There something missing'
    } else if (rating >= 2.0) {
      overview = 'Need an improvment';
    } else if (rating >= 1.5) {
      overview = '. . .';
    } else if (rating > 0) {
      overview = 'Not the BestPoint';
    } else {
      overview = 'No rating?ðŸ¥º';
    }

    ratingAltEl.textContent = overview;
  }
</script>